name: Custom Redpill
on:
  issues:
    types: [ opened, reopened ]
  workflow_dispatch:
    inputs:
      platform:
        description: 'è¯·é€‰æ‹©ä½ éœ€è¦ç¼–è¯‘çš„åž‹å·'
        required: true
        default: 'DS918+'
        type: choice
        options:
          - DS3615xs
          - DS3617xs
          - DS918+
          - DS920+
          - DS3622xs+

      version:
        description: 'è¯·é€‰æ‹©ä½ éœ€è¦ç¼–è¯‘çš„ç‰ˆæœ¬'
        required: true
        default: '6.2.4-25556'
        type: choice
        options:
          - 7.1.1-42951
          - 7.1.0-42661
          - 7.0.1-42218
          - 6.2.4-25556

      map:
        description: 'è¯·è¾“å…¥æŽ§åˆ¶å™¨ç›˜æ•°(SataPortMap)å’Œç›˜åº(DiskIdxMap)ä¸¤ä¸ªå­—æ®µ, å¹¶ä»¥","é—´éš”. eg: 0, 10'
        required: false
        default: '4, 00'
        type: string

      dtb:
        description: 'ã€ä»…DS920+ã€‘è¯·è¾“å…¥ dtb æ–‡ä»¶çš„ä¸‹è½½é“¾æŽ¥. (æ”¯æŒçš„æ–‡ä»¶ç±»åž‹: .dtsã€.dtbã€.tar.gzã€.zip)'
        required: false
        default: ''
        type: string

      sn:
        description: 'è¯·è¾“å…¥åºåˆ—å·. é»˜è®¤æ ¹æ®åž‹å·éšæœºç”Ÿæˆ. eg: 1980PDN002189'
        required: false
        default: '1910PDN917408'
        type: string

      mac:
        description: 'è¯·è¾“å…¥MACåœ°å€, å¤šä¸ªè¯·ä»¥","é—´éš”. é»˜è®¤æ ¹æ®åž‹å·éšæœºç”Ÿæˆ. eg: 001132888A95, 001132888A96'
        required: false
        default: '001132A6A825'
        type: string

      usb:
        description: 'è¯·è¾“å…¥è®¾å¤‡è¯†åˆ«ç (pid)å’Œä¾›åº”å•†ID(vid)ä¸¤ä¸ªå­—æ®µ, å¹¶ä»¥","é—´éš”. eg: 0xa4a5, 0x0525'
        required: false
        default: '0x0001, 0x46f4'
        type: string

      ext:
        description: 'è¯·è¾“å…¥æ‰©å±•é©±åŠ¨, å¤šä¸ªè¯·ä»¥ "," é—´éš”ï¼ˆè¯·é…Œæƒ…æ·»åŠ ï¼Œå¤ªå¤šèµ·ä¸æ¥ï¼‰. eg: r8125, tg3'
        required: false
        default: 'vmxnet3,e1000e,e1000'
        type: string

      exp:
        description: 'è¯·é€‰æ‹©ç¼–è¯‘ä¾èµ–çš„åŸºç¡€åº“. (7.1 ä¼˜å…ˆé€‰ pocopico, 7.0/jun ä¼˜å…ˆé€‰ jumkey.)'
        required: true
        default: 'jumkey'
        type: choice
        options:
          - 'pocopico'
          - 'jumkey'

      jun:
        description: 'è¯·é€‰æ‹©æ˜¯å¦junæ¨¡å¼ç¼–è¯‘. (ä»…7.0.1-42218 ç‰ˆæœ¬å¯é€‰, junæ¨¡å¼ æ”¯æŒ 7.0.1~7.1.0u4 çš„ DSM.)'
        required: true
        default: '0'
        type: choice
        options:
          - '0'
          - '1'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1.2

      - name: Set up Python 3
        uses: actions/setup-python@v3
        with:
          python-version: 3.8

      - name: Checkout
        uses: actions/checkout@main

      - name: Init Env
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          sudo timedatectl set-timezone "Asia/Shanghai"

          python -m pip install --upgrade pip setuptools

      - name: Get Issues Info
        if: github.event_name == 'issues'
        id: get-issues
        uses: actions/github-script@v6
        with:
          script: |
            var fs = require('fs'); // å¼•å…¥fsæ¨¡å—
            var issuenumber = ${{ toJSON(github.event.issue.number) }};
            var issueauth = ${{ toJSON(github.event.issue.user.login) }};
            var issuetitle = ${{ toJSON(github.event.issue.title) }};
            var issuebody = ${{ toJSON(github.event.issue.body) }};

            if (issuetitle != null) {
              issuetitle = issuetitle.replace(/\u000A|\u000D/g, "");  // æ¢è¡Œç¬¦,å›žè½¦
            }

            if (issuebody != null) {
              // Backspace,Tab,åž‚ç›´åˆ¶è¡¨ç¬¦,æ¢é¡µ,å›žè½¦,ä¸é—´æ–­ç©ºæ ¼,è¡Œåˆ†éš”ç¬¦,æ®µè½åˆ†éš”ç¬¦,å­—èŠ‚é¡ºåºæ ‡è®°
              issuebody = issuebody.replace(/\u0008|\u0009|\u000B|\u000C|\u000D|\u00A0|\u2028|\u2029|\uFEFF/g, "");
              // å®¹é”™
              issuebody = issuebody.replace(/ï¼š/g, ": ");
              issuebody = issuebody.replace(/ï¼Œ/g, ", ");
              issuebody = issuebody.replace(/â€œ|â€/g, "\"");
              fs.writeFileSync(`body#${issuenumber}.txt`, issuebody, { 'flag': 'w' }, (err) => { if (err) throw err; });

              var regex = /\`\`\`([\s\S]*?)\`\`\`/g;
              let options = issuebody.match(regex);
              if (options != null && options.length > 0) {
                fs.writeFileSync('customshell.sh', options[options.length-1].replace(/\`/g, ""), { 'flag': 'w' }, (err) => { if (err) throw err; });
                for(option in options) {
                  console.log(options[option]);
                  issuebody = issuebody.replace(options[option], "");
                }
              }
              // æ¢è¡Œç¬¦
              issuebody = issuebody.replace(/\u000A/g, "");
            }
            core.setOutput("issuenumber", JSON.stringify(issuenumber));
            core.setOutput("issueauth", JSON.stringify(issueauth));
            core.setOutput("issuetitle", JSON.stringify(issuetitle));
            core.setOutput("issuebody", JSON.stringify(issuebody));
      - name: Set Issues Info
        if: github.event_name == 'issues' && success()
        run: |
          echo issuenumber: "${{ steps.get-issues.outputs.issuenumber }}"
          echo issueauth:   "${{ steps.get-issues.outputs.issueauth }}"
          echo issuetitle:  "${{ steps.get-issues.outputs.issuetitle }}"
          echo issuebody:   "${{ steps.get-issues.outputs.issuebody }}"

          echo "issuenumber="${{ steps.get-issues.outputs.issuenumber }}"" >> $GITHUB_ENV
          echo "issueauth="${{ steps.get-issues.outputs.issueauth }}"" >> $GITHUB_ENV
          echo "issuetitle="${{ steps.get-issues.outputs.issuetitle }}"" >> $GITHUB_ENV
          echo "issuebody="${{ steps.get-issues.outputs.issuebody }}"" >> $GITHUB_ENV
      - name: Get Build Info
        shell: python
        id: info
        run: |
          import os, re, json, shutil, string, subprocess

          def set_output(name, value):
            subprocess.call(["echo '{}={}' >> $GITHUB_ENV".format(name, value)], shell=True)
          if __name__ == '__main__':
              issues = 'false'
              iscustom = 'true'
              errinfo = ''

              platform = 'DS3622xs+'
              version = '7.1.0-42661'
              map = ''
              dtb = ''
              sn = ''
              mac = ''
              usb = ''
              ext = ''
              exp = 'pocopico'
              jun = '0'

              errinfo = ''

              if '${{ github.event_name }}' == 'issues':
                  if '${{ env.issuetitle }}'.lower().startswith('custom'):
                      issues = 'true'
                      body = {}
                      try:
                          body = json.loads('${{ env.issuebody }}')
                          if len(body) == 0:
                              iscustom = 'false'
                              errinfo = 'body error, body is null'
                          else:
                              if 'platform' in body: platform = body['platform'].strip()
                              if 'version' in body: version = body['version'].strip()
                              if 'map' in body: map = body['map'].strip()
                              if 'dtb' in body: dtb = body['dtb'].strip()
                              if 'sn' in body: sn = body['sn'].strip()
                              if 'mac' in body: mac = body['mac'].strip()
                              if 'usb' in body: usb = body['usb'].strip()
                              if 'ext' in body: ext = body['ext'].strip()
                              if 'exp' in body: exp = body['exp'].strip()
                              if 'jun' in body: jun = body['jun'].strip()
                      except Exception as err:
                          iscustom = 'false'
                          errinfo = 'body error, {}.'.format(err)
                  else:
                      iscustom = 'false'
              else:
                  platform = '${{ github.event.inputs.platform }}'.strip()
                  version = '${{ github.event.inputs.version }}'.strip()
                  map = '${{ github.event.inputs.map }}'.strip()
                  dtb = '${{ github.event.inputs.dtb }}'.strip()
                  sn = '${{ github.event.inputs.sn }}'.strip()
                  mac = '${{ github.event.inputs.mac }}'.strip()
                  usb = '${{ github.event.inputs.usb }}'.strip()
                  ext = '${{ github.event.inputs.ext }}'.strip()
                  exp = '${{ github.event.inputs.exp }}'.strip()
                  jun = '${{ github.event.inputs.jun }}'.strip()

              if not platform in ['DS3615xs', 'DS3617xs', 'DS918+', 'DS920+', 'DS3622xs+']:
                  iscustom = 'false'
                  errinfo = 'platform parameter error'

              if not version in ['7.1.1-42951', '7.1.0-42661', '7.0.1-42218', '6.2.4-25556']:
                  iscustom = 'false'
                  errinfo = 'version parameter error'

              if map != '':
                  maps = [x.strip() for x in re.split(',| |\|', map) if x.strip() != '']
                  if len(maps) == 2 and maps[0].isdigit() and all(c in string.hexdigits for c in maps[1]) and len(maps[1]) == 2 * len(maps[0]):
                      map = ','.join(maps)
                  else:
                      iscustom = 'false'
                      errinfo = 'map parameter error'

              if dtb != '':
                  url = dtb
                  try:
                      try:
                          import wget, filetype
                      except ModuleNotFoundError:
                          os.system('pip3 install wget filetype')
                          import wget, filetype

                      res = wget.download(url)
                      if res:
                          down = res
                          kind = filetype.guess(down)
                          name = 'user'
                          if os.path.exists('extract'):
                              shutil.rmtree('extract')
                          if kind.extension == 'zip':
                              import zipfile
                              z = zipfile.ZipFile(down, 'r')
                              z.extractall('extract')
                          if kind.extension in ['tar', 'gz']:
                              import tarfile
                              z = tarfile.open(down)
                              z.extractall('extract')
                          if os.path.exists('extract'):
                              isfind = False
                              for root, dirs, files in os.walk('extract'):
                                  for file in files:
                                      if file.endswith('.dts') or file.endswith('.dtb'):
                                          isfind = True
                                          down = name + os.path.splitext(file)[-1]
                                          shutil.move(os.path.join(root, file), down)
                                          break
                                  if isfind is True:
                                      break

                          if os.path.exists(down) and (down.endswith('dts') or down.endswith('dtb')):
                              if down.endswith('dts'):
                                  wget.download('https://raw.githubusercontent.com/pocopico/rp-ext/main/redpill-dtb-static/releases/dtc')
                                  if os.path.exists('dtc'):
                                      print('./dtc -q -I dts -O dtb {} >{}.dtb'.format(down, name))
                                      os.system('sudo chmod a+x dtc')
                                      p = subprocess.Popen('sudo ./dtc -q -I dts -O dtb {} >{}.dtb'.format(down, name), shell=True, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
                                      errinfo = p.stderr.read().decode('utf-8')
                                      os.system('sudo ./dtc -q -I dts -O dtb {} >{}.dtb'.format(down, name))
                                      if os.path.exists('{}.dtb'.format(name)) and os.path.getsize('{}.dtb'.format(name)) > 0:
                                          print('dtc ok ...')
                                          dtb = os.path.abspath('{}.dtb'.format(name))
                                      else:
                                          iscustom = 'false'
                                          errinfo = 'dtb parameter error, <{}>.'.format(errinfo.replace('\r', '').replace('\n', ' '))
                                  else:
                                      iscustom = 'false'
                                      errinfo = 'dtb parameter error, <dtc tool download error, Please try again later>.'
                              else:
                                  dtb = os.path.abspath(down)
                          else:
                              iscustom = 'false'
                              errinfo = 'dtb parameter error, <urlfile error no valid ".dts/.dtb" file found>.'
                  except Exception as err:
                      iscustom = 'false'
                      errinfo = 'dtb parameter error, {}.'.format(err)

              if sn != '' and not sn.isalnum():
                  iscustom = 'false'
                  errinfo = 'sn parameter error'

              if mac != '':
                  macs = [x.strip() for x in re.split(',| |\|', mac) if x.strip() != '']
                  if len(macs) > 0 or len(macs) <= 8:
                      mac = ','.join(macs)
                  else:
                      iscustom = 'false'
                      errinfo = 'mac parameter error'

              if usb != '':
                  usbs = [x.strip() for x in re.split(',| |\|', usb) if x.strip() != '']
                  if len(usbs) == 2 \
                  and len(usbs[0]) == 6 and usbs[0].lower().startswith('0x') and all(c in string.hexdigits for c in usbs[0][2:]) \
                  and len(usbs[1]) == 6 and usbs[1].lower().startswith('0x') and all(c in string.hexdigits for c in usbs[1][2:]):
                      usb = ','.join(usbs)
                  else:
                      iscustom = 'false'
                      errinfo = 'usb parameter error'

              if ext != '':
                  try:
                      import wget
                  except ModuleNotFoundError:
                      os.system('pip3 install wget')
                      import wget
                  if os.path.exists('rpExtsFile'):
                      os.remove('rpExtsFile')
                  res = wget.download('https://raw.githubusercontent.com/pocopico/rp-ext/main/exts', out='rpExtsFile')
                  with open('rpExtsFile', mode="r") as f:
                      rpExts = f.readlines()
                  rpExts = [x.strip() for x in rpExts]
                  exts = [x.strip() for x in re.split(',| |\|', ext) if x.strip() != '']
                  if len(exts) > 0 and set(exts) <= set(rpExts):
                      ext = ','.join(exts)
                  else:
                      iscustom = 'false'
                      errinfo = 'ext parameter error'

              if not exp in ['pocopico', 'jumkey']:
                  iscustom = 'false'
                  errinfo = 'exp parameter error'

              if not jun in ['0', '1']:
                  iscustom = 'false'
                  errinfo = 'jun parameter error'

              set_output('issues', issues)
              set_output('iscustom', iscustom)
              set_output('errinfo', errinfo)
              set_output('platform', platform)
              set_output('version', version)
              set_output('map', map)
              set_output('dtb', dtb)
              set_output('sn', sn)
              set_output('mac', mac)
              set_output('usb', usb)
              set_output('ext', ext)
              set_output('exp', exp)
              set_output('jun', jun)

      - name: Echo Build Info
        run: |
          echo issues:    "${{ env.issues }}"
          echo iscustom:  "${{ env.iscustom }}"
          echo errinfo:   "${{ env.errinfo }}"
          echo platform:  "${{ env.platform }}"
          echo version:   "${{ env.version }}"
          echo map:       "${{ env.map }}"
          echo dtb:       "${{ env.dtb }}"
          echo sn:        "${{ env.sn }}"
          echo mac:       "${{ env.mac }}"
          echo usb:       "${{ env.usb }}"
          echo ext:       "${{ env.ext }}"
          echo exp:       "${{ env.exp }}"
          echo jun:       "${{ env.jun }}"

      - name: Add Issues labels
        if: env.issues == 'true' && env.iscustom == 'true'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'add-labels'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ env.issuenumber }}
          labels: 'custom'

      - name: Create Issues comment
        if: env.issues == 'true' && env.iscustom == 'true'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ env.issuenumber }}
          body: |
            ${{ env.issueauth }} æ‚¨å¥½.
            æ‚¨è‡ªå®šä¹‰çš„ Redpill å·²å¼€å§‹æž„å»ºã€‚è¯·å‰å¾€ä¸‹é¢çš„ URL æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            ----
            Hi ${{ env.issueauth }}.
            Your customized Redpill has started building. Please click the URL below to view the details.
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          emoji: heart

      - name: Create Issues comment
        if: env.issues == 'true' && env.iscustom == 'false'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ env.issuenumber }}
          body: |
            ${{ env.issueauth }} æ‚¨å¥½.
            æ‚¨è‡ªå®šä¹‰ Redpill æ‰€å¡«å†™çš„ä¿¡æ¯æ— æ³•è§£æž, è¯·å‚è€ƒæ¨¡æ¿å¹¶è¯·é‡æ–°å‘èµ·å®šåˆ¶ã€‚
            error info: ${{ env.errinfo }}
            >
            ----
            Hi ${{ env.issueauth }}.
            The information filled in by your customized Redpill cannot be parsed. Please refer to the template and restart customization.
            error info: ${{ env.errinfo }}
            >
          emoji: confused

      - name: Create Config File
        if: env.iscustom == 'true'
        shell: python
        run: |
          import os, json

          if __name__ == '__main__':
              config = {
                  "extra_cmdline": {
                      "pid": "0x0001",
                      "vid": "0x46f4",
                      "sn": "2150SQRW1ZAHH",
                      "mac1": "001132FA6CD3"
                  },
                  "synoinfo": {
                      "internalportcfg": "0xffff",
                      "maxlanport": "7"
                  },
                  "ramdisk_copy": {}
              }

              dat = []
              if '${{ env.sn }}' == '' or '${{ env.mac }}' == '':
                  try:
                      import wget
                  except ModuleNotFoundError:
                      os.system('pip3 install wget')
                      import wget
                  res = wget.download('https://raw.githubusercontent.com/pocopico/tinycore-redpill/main/serialnumbergen.sh', out='serialnumbergen.sh')
                  os.system('sed -i "s|DS3622xsp|DS3622xs+|g" serialnumbergen.sh')
                  os.system('sed -i "s|echo.*\$(generateMacAddress)|echo \$(generateMacAddress)|g" serialnumbergen.sh')
                  os.system('sed -i "s|echo.*\$(generateSerial \$1)|echo \$(generateSerial \$1)|g" serialnumbergen.sh')
                  dat = os.popen('bash ./serialnumbergen.sh ${{ env.platform }}').readlines()

              if '${{ env.sn }}' != '':
                  config["extra_cmdline"]["sn"] = '${{ env.sn }}'
              elif len(dat) == 2:
                  config["extra_cmdline"]["sn"] = dat[1].strip()

              if '${{ env.mac }}' != '':
                  macs = '${{ env.mac }}'.split(',')
                  for index, item in enumerate(macs):
                      config["extra_cmdline"]["mac{}".format(index+1)] = item.replace(':', '').upper()
                  config["extra_cmdline"]["netif_num"] = len(macs)
              elif len(dat) == 2:
                  config["extra_cmdline"]["mac1"] = dat[0].strip().replace(':', '')
                  config["extra_cmdline"]["mac2"] = hex(int(dat[0].strip().replace(':', ''), 16) + 1)[2:].rjust(12,'0').upper()
                  config["extra_cmdline"]["netif_num"] = 2

              if '${{ env.map }}' != '':
                  maps = '${{ env.map }}'.split(',')
                  if len(maps) == 2:
                      config["extra_cmdline"]["SataPortMap"] = maps[0]
                      config["extra_cmdline"]["DiskIdxMap"] = maps[1]

              if '${{ env.usb }}' != '':
                  usbs = '${{ env.usb }}'.split(',')
                  if len(usbs) == 2:
                      config["extra_cmdline"]["pid"] = usbs[0]
                      config["extra_cmdline"]["vid"] = usbs[1]

              print(json.dumps(config, indent=4))

              with open('user_config.json', 'w', encoding="utf-8") as f:
                  f.write(json.dumps(config, indent=4))

      - name: Run Build
        if: env.iscustom == 'true' && success()
        run: |
          function exdsmpat() {
            pwd
            cd ./cache
            path=7.0.1/42218
            if [ "$2" == "42661" ]; then
              path=7.1/42661-1
            fi
            if [ "$2" == "42951" ]; then
              path=7.1.1/42951
            fi
            curl -L https://cndl.synology.cn/download/DSM/release/${path}/DSM_$1_$2.pat -o ds.pat
            curl -L https://cndl.synology.cn/download/DSM/release/7.0.1/42218/DSM_$1_42218.pat -o oldpat.tar.gz
            mkdir synoesp && tar -C./synoesp/ -xf oldpat.tar.gz rd.gz
            cd synoesp
            xz -dc < rd.gz >rd 2>/dev/null || echo "extract rd.gz"
            cpio -idm <rd 2>&1 || echo "extract rd"
            mkdir extract
            cp ./usr/lib/libcurl.so.4 ./usr/lib/libmbedcrypto.so.5 ./usr/lib/libmbedtls.so.13 ./usr/lib/libmbedx509.so.1 ./usr/lib/libmsgpackc.so.2 ./usr/lib/libsodium.so ./usr/lib/libsynocodesign-ng-virtual-junior-wins.so.7 ./usr/syno/bin/scemd ./extract/
            cd extract && ln -s scemd syno_extract_system_patch && cd ..
            cd ..
            mkdir pat
            sudo LD_LIBRARY_PATH=synoesp/extract synoesp/extract/syno_extract_system_patch ds.pat pat || echo "extract latest pat"
            tar -czvf $3 -C ./pat/ . --warning=no-file-changed
            ls -al
            sudo rm -rf ds.pat oldpat.tar.gz synoesp pat
            ls -al
            sha256sum $3
            cd ..
            pwd
          }

          sudo apt-get update
          sudo apt-get upgrade -y
          sudo apt-get install curl bspatch jq git -y

          # å¼€å§‹è¡¨æ¼”
          repo=${{ env.exp }}
          branch=develop
          bArgs=''
          if [ ${{ env.jun }} == '1' ]; then
            bArgs='BRP_JUN_MOD=1 BRP_DEBUG=1'
            if [ ${repo} == 'pocopico' ]; then
              branch=jun
            fi
          fi
          echo -e "\n\nCurrent path: `pwd`\n"

          synoplatform=$(echo ${{ env.platform }} | sed 's/DS/ds/g; s/+/p/g')       # DS3622xs+ => ds3622xsp
          synoversion=$(echo ${{ env.version }} | awk -F - '{print $2}')            # 7.0.1-42218 => 42218

          # 7.1 è§£å¯†PAT
          if [[ "${{ env.version }}" > "7.0.1-42218" ]]; then
            newpat=${synoplatform}_${synoversion}.pat
            exdsmpat ${{ env.platform }} ${synoversion} ${newpat}
            ls -al ./cache
            configfile=./config/${{ env.platform }}/${{ env.version }}/config.json
            jq -r .os.sha256 ${configfile}
            sed -i "s/$(jq -r .os.sha256 ${configfile})/$(sha256sum ./cache/${newpat} | awk '{print $1}')/g" ${configfile}
            jq -r .os.sha256 ${configfile}
          fi

          # æ·»åŠ å¿…å¤‡é©±åŠ¨
          #./ext-manager.sh add https://raw.githubusercontent.com/${repo}/redpill-load/${branch}/redpill-boot-wait/rpext-index.json
          sudo chmod +x ./ext-manager.sh
          sudo BASH_SOURCE="`pwd`/" ./ext-manager.sh add https://github.com/winser528/redpill-load-generation/raw/master/extensions/redpill-acpid.json
          sudo BASH_SOURCE="`pwd`/" ./ext-manager.sh add https://github.com/winser528/redpill-load-generation/raw/master/extensions/redpill-misc.json
          sudo BASH_SOURCE="`pwd`/" ./ext-manager.sh add https://github.com/winser528/redpill-load-generation/raw/master/extensions/redpill-virtio.json
          # Linuxå†…æ ¸æ¨¡å—æ˜¯ä¸€ç§åŠ¨æ€åŠ è½½
          extension=$(curl -s --location "https://raw.githubusercontent.com/pocopico/rp-ext/master/redpill/rpext-index.json")
          redpilltgz=$(curl -s --location "$(echo ${extension} | jq -r .releases.${synoplatform}_${synoversion})" | jq -r '.files[] .url')
          [ "$(echo $redpilltgz | awk '{print $NF}')" != "$redpilltgz" ] && redpilltgz=$(echo $redpilltgz | awk '{print $1}')
          echo -e "\n\nStart downloading: ${redpilltgz}\n\n"
          wget ${redpilltgz}
          tar zxvf $(echo ${redpilltgz} | awk -F / '{print $NF}') -C ./
          mv ./redpill.ko ./ext/rp-lkm/redpill-linux-v$(modinfo redpill.ko | grep vermagic | awk '{print $2}').ko
          # åˆ¤æ–­æ˜¯æŒ‡å®šç‰ˆæœ¬
          if [ ${{ env.platform }} == 'DS920+' ]; then
            sudo BASH_SOURCE="`pwd`/" bash ext-manager.sh add https://raw.githubusercontent.com/pocopico/rp-ext/master/redpill-dtb-static/rpext-index.json
            sudo BASH_SOURCE="`pwd`/" bash ext-manager.sh _update_platform_exts ${synoplatform}_${synoversion} redpill-dtb-static

            if [ -n "${{ env.dtb }}" ]; then
              dtbuserfile="${{ env.dtb }}"
              dtbextfile="$(find custom -name model_${synoplatform}.dtb)"
              echo Copying ${dtbuserfile} to ${dtbextfile} ...
              sudo cp ${dtbuserfile} ${dtbextfile}
            fi
          fi
          # æ·»åŠ æ‰©å±•é©±åŠ¨
          if [ -n "${{ env.ext }}" ]; then
            ext=${{ env.ext }}
            exts=(${ext//,/ })
            for item in ${exts[@]}
            do
              sudo BASH_SOURCE="`pwd`/" bash ext-manager.sh add "https://raw.githubusercontent.com/pocopico/rp-ext/master/${item}/rpext-index.json"
            done
          fi
          # ç¼–è¯‘
          # sed -i "s|#!/usr/bin/env bash|#!/usr/bin/env -S bash -x|g" ./build-loader.sh
          sudo ${bArgs} BRP_USER_CFG=user_config.json BASH_SOURCE="`pwd`/" bash build-loader.sh '${{ env.platform }}' '${{ env.version }}'
          ls -al ./custom/extensions

      - name: Generate release tag
        if: env.iscustom == 'true' && success()
        id: tag
        run: |
          if [ "${{ env.issues }}" == "true" ]; then
            echo "### ${{ env.issueauth }}'s Redpill Custom" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ‘‰ issues: [#${{ env.issuenumber }}]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/issues/${{ env.issuenumber }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "### $(echo "$GITHUB_REPOSITORY" | awk -F / '{print $1}')'s Redpill Custom" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ‘‰ "platform": "${{ env.platform }}"  " >> $GITHUB_STEP_SUMMARY
            echo "ðŸ‘‰ "version": "${{ env.version }}", "jun": "${{ env.jun }}"  " >> $GITHUB_STEP_SUMMARY
            echo "ðŸ‘‰ "ext": "${{ env.ext }}"  " >> $GITHUB_STEP_SUMMARY
          fi

          echo "release_tag=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT
          echo "repository_name=$(echo $GITHUB_REPOSITORY | awk -F / '{print $2}')" >> $GITHUB_OUTPUT

      - name: Upload to Artifacts
        if: env.iscustom == 'true' && success()
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.tag.outputs.repository_name }}-Custom-${{ steps.tag.outputs.release_tag }}
          path: |
            /home/runner/work/redpill-load/redpill-load/user_config.json
            /home/runner/work/redpill-load/redpill-load/images/*.img

      - name: Generate release tag
        if: env.iscustom == 'false'
        run: |
          if [ "${{ env.issues }}" == "true" ]; then
            echo "### ${{ env.issueauth }}'s Redpill Custom" >> $GITHUB_STEP_SUMMARY
          else
            echo "### $(echo "$GITHUB_REPOSITORY" | awk -F / '{print $1}')'s Redpill Custom" >> $GITHUB_STEP_SUMMARY
          fi
          echo "ðŸ˜ž ðŸ˜” ðŸ˜Ÿ ðŸ˜• ðŸ™ â˜¹ï¸ ðŸ˜£ ðŸ˜– ðŸ˜« ðŸ˜© ðŸ¥º ðŸ˜¢  " >> $GITHUB_STEP_SUMMARY
          echo "æ‚¨è‡ªå®šä¹‰ Redpill æ‰€å¡«å†™çš„ä¿¡æ¯æ— æ³•è§£æž, è¯·å‚è€ƒæ¨¡æ¿å¹¶è¯·é‡æ–°å‘èµ·å®šåˆ¶ã€‚  " >> $GITHUB_STEP_SUMMARY
          echo "error info: ${{ env.errinfo }}  " >> $GITHUB_STEP_SUMMARY

      - name: Create Issues Comment
        if: env.issues == 'true' && env.iscustom == 'true' && success()
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ env.issuenumber }}
          body: |
            ${{ env.issueauth }} æ‚¨å¥½.
            æ‚¨è‡ªå®šä¹‰çš„ Redpill å·²æž„å»ºå®Œæˆã€‚è¯·å‰å¾€ä¸‹é¢çš„ URL ä¸‹è½½ã€‚
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            ----
            Hi ${{ env.issueauth }}.
            Your customized Redpill has been builded. Please click the URL below to download it.
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          emoji: hooray

      - name: Close Issues
        if: env.issues == 'true' && env.iscustom == 'true' && success()
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'close-issue'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ env.issuenumber }}

      - name: Create Issues Comment
        if: env.issues == 'true' && env.iscustom == 'true' && failure()
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ env.issuenumber }}
          body: |
            ${{ env.issueauth }} æ‚¨å¥½.
            æ‚¨è‡ªå®šä¹‰çš„ Redpill æž„å»ºå¤±è´¥ã€‚è¯·å‰å¾€ä¸‹é¢çš„ URL æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚è¯·è‡ªè¡Œå…³é—­æœ¬ Issues å¹¶åœ¨è¿›è¡Œè°ƒæ•´åŽé‡æ–°åˆ›å»ºä¸€ä¸ª Issues æ¥å‘èµ·é‡æ–°æž„å»ºã€‚
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            ----
            Hi ${{ env.issueauth }}.
            Your customized Redpill build failed. Please click the URL below to view the details. Please close this issue by yourself and re create an issue after adjustment to initiate the rebuild.
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          emoji: hooray
